<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>권한 관리</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.css" />
  <link rel="stylesheet" href="https://uicdn.toast.com/tui-tree/latest/tui-tree.css" />
  <style>
    body { padding: 20px; font-family: sans-serif; }
    #layout { display: flex; gap: 30px; }
    #menu-tree { width: 300px; height: 500px; border: 1px solid #ccc; padding: 10px; overflow: auto; }
    #role-grid { width: 500px; height: 500px; }
    #controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
  </style>
</head>
<body>
  <h2>권한 관리</h2>
  <div id="layout">
    <div>
      <h5>메뉴 리스트</h5>
      <div id="menu-tree"></div>
    </div>
    <div>
      <h5>권한 리스트</h5>
      <div id="role-grid"></div>
    </div>
  </div>

  <div id="controls">
    <button onclick="createRole()" class="btn btn-primary">신규</button>
    <button onclick="editRole()" class="btn btn-warning">수정</button>
    <button onclick="deleteRole()" class="btn btn-danger">삭제</button>
    <button onclick="saveMapping()" class="btn btn-success">저장</button>
  </div>

  <script src="https://uicdn.toast.com/tui-code-snippet/latest/tui-code-snippet.min.js"></script>
  <script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.min.js"></script>
  <script src="https://uicdn.toast.com/tui-tree/latest/tui-tree.min.js"></script>
  <script>
    const roles = [
      { id: 1, name: '관리자' },
      { id: 2, name: '사용자' }
    ];

    const menus = [
      { id: 1, text: '대시보드' },
      { id: 2, text: '사용자 관리', children: [
        { id: 3, text: '사용자 등록' },
        { id: 4, text: '사용자 삭제' }
      ]},
      { id: 5, text: '게시판 관리' }
    ];

    const roleMenuMap = {
      1: [1, 2, 3, 4, 5],
      2: [1]
    };

    let selectedRoleId = null;

    const tree = new tui.Tree('#menu-tree', {
      nodes: menus,
      checkbox: true,
      selectable: false,
      expandIcon: true
    });

    const grid = new tui.Grid({
      el: document.getElementById('role-grid'),
      data: roles,
      rowHeaders: ['rowNum'],
      columns: [
        { header: 'ID', name: 'id', width: 60 },
        { header: '권한명', name: 'name', editor: 'text' }
      ]
    });

    grid.on('click', ev => {
      const row = grid.getRow(ev.rowKey);
      selectedRoleId = row.id;
      syncTreeWithRole(selectedRoleId);
    });

    function syncTreeWithRole(roleId) {
      tree.uncheckAll();
      const list = roleMenuMap[roleId] || [];
      list.forEach(id => {
        const node = tree.getNode(id);
        if (node) tree.check(id);
      });
    }

    function createRole() {
      const name = prompt('새 권한명을 입력하세요');
      if (!name) return;
      const id = Date.now();
      grid.appendRow({ id, name });
      roleMenuMap[id] = [];
    }

    function editRole() {
      const rowKey = grid.getFocusedCell()?.rowKey;
      if (rowKey === null || rowKey === undefined) return alert('수정할 권한을 선택하세요.');
      const current = grid.getRow(rowKey);
      const newName = prompt('권한명을 수정하세요', current.name);
      if (newName) {
        grid.setValue(rowKey, 'name', newName);
      }
    }

    function deleteRole() {
      const rowKey = grid.getFocusedCell()?.rowKey;
      if (rowKey === null || rowKey === undefined) return alert('삭제할 권한을 선택하세요.');
      const { id } = grid.getRow(rowKey);
      if (confirm('정말 삭제하시겠습니까?')) {
        grid.removeRow(rowKey);
        delete roleMenuMap[id];
        selectedRoleId = null;
        tree.uncheckAll();
      }
    }

    function saveMapping() {
      if (!selectedRoleId) return alert('먼저 권한을 선택하세요.');
      const checked = tree.getCheckedList(true).map(n => n.id);
      roleMenuMap[selectedRoleId] = checked;
      alert(`권한 ${selectedRoleId}에 메뉴 매핑 저장됨: ${checked.join(', ')}`);
    }
  </script>
</body>
</html>
