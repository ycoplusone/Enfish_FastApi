{% include "Basis/head.html" %}

{% include "Basis/navigation.html" %}
  <div class="container">
    <h2 class="mb-4">메뉴 관리</h2>

    <!-- 메뉴 추가 폼 -->
    <div class="card mb-4">
      <div class="card-body">
        <form onsubmit="handlesubmit(event)" class="row g-2">
            <input type="hidden" class="form-control" id="seq" placeholder="seq" disabled>
          <div class="col-md-2">
            <input type="text" class="form-control" id="menu_id" placeholder="메뉴ID" required>
          </div>            
          <div class="col-md-3">
            <input type="text" class="form-control" id="menu_nm" placeholder="메뉴명" required>
          </div>
          <div class="col-md-2">
            <input type="text" class="form-control" id="parent_nm" placeholder="상위명" required>
          </div>          
          <div class="col-md-2">
            <input type="text" class="form-control" id="url_path" placeholder="URL" required>
          </div>

          <div class="col-md-1">
            <select class="form-select" id="use_yn" name="use_yn">
              <option value="Y" selected>사용</option>
              <option value="N">미사용</option>
            </select>
          </div>

          <div class="col-md-1">
            <button type="submit" class="btn btn-primary" id="form_btn">확인</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 메뉴 목록 -->
    <table class="table table-bordered" id="menu-table">
      <thead class="table-light">
        <tr>
          <th>Seq</th>
          <th>메뉴ID</th>
          <th>메뉴명</th>
          <th>상위명</th>
          <th>URL</th>
          <th>사용여부</th>
          <th style="width: 150px;">동작</th>
        </tr>
      </thead>
      <tbody>
        <!-- JavaScript로 동적 추가 -->
      </tbody>
    </table>
  </div>

  <script>
    // 메뉴 목록을 서버에서 가져와서 테이블에 추가
    MenuSelects();
    function MenuSelects(){
      console.log('MenuSelects() 호출됨');
      // 서버에서 메뉴 목록을 가져오는 함수
      fnCurl('GET', '/sys/menus','').then(result => {
        if (result.status_code === 200) {
            const tableBody = document.querySelector('#menu-table tbody');
            tableBody.innerHTML = '';
            result.detail.forEach(menu => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${menu.seq}</td>
              <td>${menu.menu_id}</td>
              <td>${menu.menu_nm}</td>
              <td>${menu.parent_nm}</td>
              <td>${menu.url_path}</td>
              <td>${menu.use_yn}</td>
              <td>
                <button class="btn btn-sm btn-warning me-1 edit-btn" data-id="${menu.seq}">수정</button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${menu.seq}" onclick="MenuDelete(${menu.seq})">삭제</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        } else {
          alert(result.detail);
        }
      });
    }

    // 메뉴 추가 폼 제출 처리
    function handlesubmit(event) {
      event.preventDefault(); // 폼 제출 기본 동작 방지 
      const seq = document.getElementById('seq').value.trim();
      const menuId = document.getElementById('menu_id').value.trim();
      const menuNm = document.getElementById('menu_nm').value.trim();
      const parentNm = document.getElementById('parent_nm').value.trim();
      const urlPath = document.getElementById('url_path').value.trim();
      const use_yn = document.getElementById('use_yn').value.trim();

      if (!menuId || !menuNm || !parentNm || !urlPath || !use_yn) {
        alert('모든 필드를 입력해주세요.');
        return;
      }

      if (seq == ''){
        // 서버에 메뉴 추가 요청
        const param = {
          menu_id: menuId,
          menu_nm: menuNm,
          parent_nm: parentNm,
          url_path: urlPath,
          use_yn: use_yn
        };
        fnCurl('POST', '/sys/menu', param).then(result => {
          if (result.status_code === 200) {
            //alert(result.detail);
            MenuSelects(); // 메뉴 목록 새로고침
            // 폼 초기화
            document.getElementById("seq").value = '';
            document.getElementById("menu_id").value = '';
            document.getElementById("menu_nm").value = '';
            document.getElementById("parent_nm").value = '';
            document.getElementById("url_path").value = '';
            document.getElementById("use_yn").value = 'Y';
          } else {
            alert(result.detail);
          }
        });
      }else{
        // 서버에 메뉴 추가 요청
        const param = {
          seq: seq,
          menu_id: menuId,
          menu_nm: menuNm,
          parent_nm: parentNm,
          url_path: urlPath,
          use_yn: use_yn
        };
        fnCurl('PUT', '/sys/menu', param).then(result => {
          if (result.status_code === 200) {
            //alert(result.detail);
            MenuSelects(); // 메뉴 목록 새로고침
            // 폼 초기화
            document.getElementById("seq").value = '';
            document.getElementById("menu_id").value = '';
            document.getElementById("menu_nm").value = '';
            document.getElementById("parent_nm").value = '';
            document.getElementById("url_path").value = '';
            document.getElementById("use_yn").value = 'Y';
            document.getElementById('form_btn').innerHTML = '확인';
          } else {
            alert(result.detail);
          }
        });        
      }
    }    

    // 메뉴 삭제 버튼 클릭 처리    
    function MenuDelete(seq) {
      if (confirm('정말 삭제하시겠습니까?')) {
        fnCurl('DELETE', `/sys/menu/${seq}`, '').then(result => {
          if (result.status_code === 200) {
            //alert(result.detail);
            console.log('??');
            MenuSelects(); // 메뉴 목록 새로고침
            console.log('!!');
          } else {
            alert(result.detail);
          }
        });
      }
    }

    const tableBody = document.querySelector('#menu-table tbody');
    tableBody.addEventListener('click', function (e) {
      const target = e.target;
      const row = target.closest('tr');

      if (target.classList.contains('edit-btn')) {
        document.getElementById('seq').value        = row.children[0].textContent;
        document.getElementById('menu_id').value    = row.children[1].textContent;
        document.getElementById('menu_nm').value    = row.children[2].textContent;
        document.getElementById('parent_nm').value  = row.children[3].textContent;
        document.getElementById('url_path').value   = row.children[4].textContent;
        document.getElementById('use_yn').value     = row.children[5].textContent;
        document.getElementById('form_btn').innerHTML = '수정';
      }
    });
  </script>  

{% include "Basis/foot.html" %}
